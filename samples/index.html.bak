<!doctype html>
<html ng-app="epiquery-tool">
<head>
<title></title>
  <style>
    results { width: 90%; margin-left: auto; margin-right:auto; }
  </style>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="/js/lodash.min.js" type="text/javascript"></script>
  <script src="http://variablesky.glgqashared.com:9999/variablesky.client"></script>
  <script type="text/javascript">
    _.extend($,{
      parseQueryString: function(str){
        var nvpair = {};
        var qs = str || window.location.search.replace('?', '');
        var pairs = qs.split('&');
        $.each(pairs, function(i, v){
          var pair = v.split('=');
          nvpair[pair[0]] = pair[1];
        });
        return nvpair;
      }
    });
    var angApp = angular.module('epiquery-tool', []);
    var vsClient = variablesky.connect("ws://variablesky.glgqashared.com:9999/variablesky");

    function QueryController($scope, $http){
      var lastTemplateLink  = vsClient.link('epiquery.sample.mru.template').toAngular($scope, 'lastTemplate')
      var templateText  = vsClient.link('epiquery.sample.mru.templateText').toAngular($scope, 'templateText')
      var lastRequestData  = vsClient.link('epiquery.sample.mru.requestParams').toAngular($scope, 'requestData')

      $scope.templateEngines = ['dot', 'mustache'];
      $scope.selectedEngine = $scope.templateEngines[1];
      var getEpiUrl = function(templateName){
        //epiUrl = 'https://passwdsvc:YepRud37@query.glgroup.com/' + $scope.lastTemplate + "?callback=?"
        if (templateName){
          return 'http://query.glgqashared.com/' + templateName + '?callback=JSON_CALLBACK';
        } else {
          return 'http://query.glgqashared.com/';
        }
      }
      var displayResults = function(data){
          $scope.results = JSON.stringify(data, null, 2);
          console.log($scope.results);
      };
      $scope.doQuery = function(){
        console.log("doQuery(" + $scope.lastTemplate + ")");
        $http.jsonp(getEpiUrl($scope.lastTemplate)).
          success(displayResults).
          error(
            function(data, status, headers, config){
              console.log("Error " + status + " " + data);
            }
        );
        lastTemplateLink.save();
      }
      $scope.sendTemplate = function(){
        console.log("sendTemplate()");
        console.log(lastTemplateLink == templateText);
        templateText.save();
        lastRequestData.save();
        config = $.parseQueryString($scope.requestData);
        _.extend(config, {
          "__template": $scope.templateText,
          "__template_type": $scope.selectedEngine
        });
        console.log(config);
        $http.post(getEpiUrl(), config).
          success(displayResults).
          error(
            function(data, status, headers, config){
              console.log("error during sendTemplate()");
              console.log(data);
              displayResults(data);
            }
          );
      }
    }
  </script>
</head>
<body>
  <span ng-controller="QueryController">
    <label for="requestData">Request Data: </label><input size=100 type="text" ng-model="requestData">
    <p>
    <label for="lastTemplate">Template: </label><input size=100 type="text" ng-model="lastTemplate" >
    <input type="button" value="Run" ng-click="doQuery()"/>
    <div style="border: 1px solid black;">
      <label for="templateText"></label><textarea id="templateText" ng-model="templateText"></textarea>
      <select ng-model="selectedEngine" ng-options="name for name in templateEngines">
      </select>
      <input ng-click="sendTemplate()" type="button" value="Run"/>
    </div>
    <pre class="prettyprint" ng-bind-html-unsafe="results"></pre>
  </span>
</body>
</html>
