#! /usr/bin/env bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ROOT=$PWD
NEEDED_NODE_VERSION='v0.10.3'
source "${DIR}/.nvm.sh"
which node > /dev/null 2>&1
if [ $? == 0 ]; then
  CURRENT_NODE_VERSION=`node --version`
  HAS_NEEDED_VERSION=`nvm ls | grep ${NEEDED_NODE_VERSION}`
fi

if [ -e ~/.epiquery_env ]; then
  source ~/.epiquery_env
fi

if [ -z "${HAS_NEEDED_VERSION}" ]; then
  echo 'get the right version of node going'
  nvm install $NEEDED_NODE_VERSION
  nvm alias default $NEEDED_NODE_VERSION
  npm update
fi

PKG_BIN=`npm bin`

nvm use $NEEDED_NODE_VERSION
export ENVIRONMENT_SHA=`git log -1 --oneline | awk '{ print $1 }'`

# we'll default our templates directory to the ./templates in the directory 
# from which we're running
if [ -z "${EPIQUERY_TEMPLATE_DIRECTORY}" ]; then
  export EPIQUERY_TEMPLATE_DIRECTORY=`pwd`/templates
  echo "Using template directory ${EPIQUERY_TEMPLATE_DIRECTORY}"
fi

# if not provided we'll provide a 'sensible' default which looks like the
# existing repo name with .git replaced with -templates.git
if [ -z "${EPIQUERY_TEMPLATE_REPOSITORY}" ]; then
  ORIGIN=`git remote -v | grep origin | grep fetch | awk '{ print $2}'`
  ORIG_BASENAME=`basename ${ORIGIN}`
  export TEMPLATE_BASENAME=`echo ${ORIG_BASENAME} | sed -e s[\.git[-templates.git[g`
  if [ "${ORIG_BASENAME}" == "${TEMPLATE_BASENAME}" ]; then
	TEMPLATE_BASENAME="${ORIG_BASENAME}-templates"
  fi
  export EPIQUERY_TEMPLATE_REPOSITORY=`echo ${ORIGIN} | sed -e s[${ORIG_BASENAME}[${TEMPLATE_BASENAME}[g`
  echo "Setting template repository to ${EPIQUERY_TEMPLATE_REPOSITORY}"
fi

set_config(){
  if [ -z "${2}" ]; then
    echo Missing config value from environment for ${1}
    exit 1
  fi
  npm config set $1 $2
}

export EPIQUERY_SQL_SERVER=${EPIQUERY_SQL_SERVER-192.168.200.55}
export EPIQUERY_SQL_PORT=${EPIQUERY_SQL_PORT-1433}
export EPIQUERY_SQL_USER=${EPIQUERY_SQL_USER-GLGROUP_LIVE}
export EPIQUERY_SQL_PASSWORD=${EPIQUERY_SQL_PASSWORD-GLGROUP_LIVE}
export EPIQUERY_SQL_RO_USER=${EPIQUERY_SQL_RO_USER-GLGROUP_LIVE}
export EPIQUERY_SQL_RO_PASSWORD=${EPIQUERY_SQL_RO_PASSWORD-GLGROUP_LIVE}
export EPIQUERY_MYSQL_SERVER=${EPIQUERY_MYSQL_SERVER-10.45.110.110}
export EPIQUERY_MYSQL_USER=${EPIQUERY_MYSQL_USER-glguser}
export EPIQUERY_MYSQL_PASSWORD=${EPIQUERY_MYSQL_PASSWORD-d1r3ct0r}
export EPIQUERY_MYSQL_RO_USER=${EPIQUERY_MYSQL_RO_USER-boduser}
export EPIQUERY_MYSQL_RO_PASSWORD=${EPIQUERY_MYSQL_RO_PASSWORD-password_1}
export EPIQUERY_TEMPLATE_DIRECTORY=${"EPIQUERY_TEMPLATE_DIRECTORY?"you need a template directory""}
export EPIQUERY_TEMPLATE_REPOSITORY=${EPIQUERY_TEMPLATE_REPOSITORY?"need a template repository"}
export EPIQUERY_TEMPLATE_UPDATE_INTERVAL=${EPIQUERY_TEMPLATE_UPDATE_INTERVAL-60000}
export EPIQUERY_HTTP_PORT=${EPIQUERY_HTTP_PORT-6060}
